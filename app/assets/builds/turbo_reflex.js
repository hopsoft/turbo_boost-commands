var c={beforeStart:"turbo-reflex:before-start",start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",error:"turbo-reflex:error",missingFrame:"turbo-reflex:missing-frame",missingFrameSrc:"turbo-reflex:missing-frame-src"},p={debug:Object.values(c),info:Object.values(c),warn:[c.abort,c.error,c.missingFrame,c.missingFrameSrc],error:[c.abort,c.error,c.missingFrame,c.missingFrameSrc],unknown:[]},f="unknown";Object.values(c).forEach(t=>{document.addEventListener(t,e=>{p[f].includes(e.type)&&console[f==="debug"?"log":f](e.type,e)})});var n={events:{...c},dispatch:(t,e=document,r={})=>{let s=new CustomEvent(t,{detail:r,cancelable:!0,bubbles:!0});e.dispatchEvent(s)},get logLevel(){return f},set logLevel(t){return Object.keys(p).includes(t)||(t="unknown"),f=t}};var o={get element(){return document.getElementById("turbo-reflex")},get token(){return document.getElementById("turbo-reflex").getAttribute("content")}};function h(t){return t.closest("[data-turbo-reflex]")}function T(t){return t.closest("turbo-frame")}function E(t){let e=t.dataset.turboFrame;if(!e){let r=T(t);r&&(e=r.id)}return e}function L(t){let e=document.getElementById(t);if(!e){let r=`The frame '${t}' does not exist!`;n.dispatch(n.events.missingFrame,document,{message:r})}return e}function k(t){let e=t.dataset.turboReflexSrc||t.src;if(!e){let r=`The the 'src' for <turbo-frame id='${t.id}'> is unknown!
      TurboReflex uses 'src' to (re)render frame content after the reflex is invoked.
      Please set the 'src' or 'data-turbo-reflex-src' attribute on the <turbo-frame> element.`;n.dispatch(n.events.missingFrameSrc,t,{message:r})}return e}function O(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,s)=>(s.selected&&r.push(s.value),r),[])}function y(t){let e=Array.from(t.attributes).reduce((r,s)=>(r[s.name]=s.value,r),{});return e.tag=t.tagName,e.checked=t.checked,e.disabled=t.disabled,O(t,e),e}var x={};addEventListener("turbo:before-fetch-request",t=>{let e=t.target.closest("turbo-frame"),r=o.element.detail||{};if(e!=r.frame)return;let{fetchOptions:s}=t.detail;s.headers["TurboReflex-Token"]=o.token});addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame");e&&(x[e.id]=e.src);let r=o.element.detail||{};e==r.frame&&(delete o.element.dataset.busy,delete o.element.detail,n.dispatch(n.events.finish,r.element||document,r))});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.turboReflexSrc=x[e.id]||e.src||e.dataset.turboReflexSrc,delete x[e.id]});function b(t){let e=document.createElement("a");return e.href=t,new URL(e)}function v(t){let e=o.element.detail||{},r=e.element||document;delete o.element.dataset.busy,delete o.element.detail,n.dispatch(t,r,e),n.dispatch(n.events.finish,r,e)}function I(t){let e=t.target,r={...t.detail,...o.element.detail||{}};debugger;v(n.events.abort)}function C(t){let e=t.target,r={...t.detail,...o.element.detail||{}};v(n.events.error)}function j(t){let e=t.target,r=e.responseText,s=e.getResponseHeader("TurboReflex-Hijacked")==="true";if(e.status>=200&&e.status<=299){if(s){let l="<turbo-stream",i="</turbo-stream>",a=r.indexOf(l),u=r.lastIndexOf(i);if(a>=0&&u>=0){let g=r.slice(a,u+i.length);document.body.insertAdjacentHTML("beforeend",g)}}else{let l="<html",i="</html",a=r.indexOf(l),u=r.lastIndexOf(i);if(a>=0&&u>=0){let g=r.slice(r.indexOf(">",a)+1,u);document.documentElement.innerHTML=g}}v(n.events.success)}else{let{status:l,statusText:i}=e,a={responseStatus:l,responseStatusText:i,responseText:e.responseText};e.dispatchEvent(new CustomEvent("error",{detail:a}))}}function A(t){let e=b(window.location.href);e.searchParams.set("turbo_reflex",JSON.stringify(t));let r=new XMLHttpRequest;r.open("GET",e,!0),r.setRequestHeader("TurboReflex-Token",o.token),r.addEventListener("abort",I),r.addEventListener("error",C),r.addEventListener("load",j),r.send()}var R=A;var d={},w;function F(t){w=t}function m(t,e){d[t]=e,document.addEventListener(t,w,!0)}function S(t,e){return e=e.toLowerCase(),d[t].includes(e)||!Object.values(d).flat().includes(e)&&d[t].includes("*")}function H(t,e){let r=k(t);if(!r)return;let s=b(r);s.searchParams.set("turbo_reflex",JSON.stringify(e)),t.src=s.toString()}function P(t,e={}){e.token=o.token;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(e),t.appendChild(r)}function q(t){let e,r={};try{if(e=h(t.target),!e||!S(t.type,e.tagName))return;n.dispatch(n.events.beforeStart,e);let s=E(e),l;if(s&&(l=L(s),!l))return;let i="window";l&&(i="frame"),e.tagName.toLowerCase()==="form"&&(i="form");let a={driver:i,element:y(e)};switch(r={...a,frame:l,element:e},o.element.dataset.busy=!0,o.element.detail=r,n.dispatch(n.events.start,e,r),i!=="form"&&t.preventDefault(),i){case"frame":H(l,a);break;case"form":P(e,a);break;case"window":R(a);break}}catch(s){r.error=s,console.error("TurboReflex encountered an unexpected error!",r),n.dispatch(n.events.error,e||document,r)}}F(q);m("change",["input","select","textarea"]);m("submit",["form"]);m("click",["*"]);var re={registerEvent:m,get registeredEvents(){return{...d}},get lifecycleEvents(){return[...Object.values(n.events)]},get logLevel(){return n.logLevel},set logLevel(t){return n.logLevel=t}};export{re as default};
//# sourceMappingURL=turbo_reflex.js.map
