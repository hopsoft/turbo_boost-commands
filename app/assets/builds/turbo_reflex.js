var i={beforeStart:"turbo-reflex:before-start",start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",error:"turbo-reflex:error",missingFrame:"turbo-reflex:missing-frame",missingFrameSrc:"turbo-reflex:missing-frame-src"},E={debug:Object.values(i),info:Object.values(i),warn:[i.abort,i.error,i.missingFrame,i.missingFrameSrc],error:[i.abort,i.error,i.missingFrame,i.missingFrameSrc],unknown:[]},m="unknown";Object.values(i).forEach(t=>{document.addEventListener(t,e=>{E[m].includes(e.type)&&console[m==="debug"?"log":m](e.type,e)})});var s={events:{...i},dispatch:(t,e=document,r={})=>{let n=new CustomEvent(t,{detail:r,cancelable:!0,bubbles:!0});e.dispatchEvent(n)},get logLevel(){return m},set logLevel(t){return Object.keys(E).includes(t)||(t="unknown"),m=t}};function S(t){return t.closest("[data-turbo-reflex]")}function k(t){return t.closest("turbo-frame")}function F(t){let e=t.dataset.turboFrame;if(!e){let r=k(t);r&&(e=r.id)}return e}function O(t){let e=document.getElementById(t);if(!e){let r=`The frame '${t}' does not exist!`;s.dispatch(s.events.missingFrame,document,{message:r})}return e}function I(t){let e=t.dataset.turboReflexSrc||t.src;if(!e){let r=`The the 'src' for <turbo-frame id='${t.id}'> is unknown!
      TurboReflex uses 'src' to (re)render frame content after the reflex is invoked.
      Please set the 'src' or 'data-turbo-reflex-src' attribute on the <turbo-frame> element.`;s.dispatch(s.events.missingFrameSrc,t,{message:r})}return e}function j(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,n)=>(n.selected&&r.push(n.value),r),[])}function C(t){let e=Array.from(t.attributes).reduce((r,n)=>(r[n.name]=n.value,r),{});return e.tag=t.tagName,e.checked=t.checked,e.disabled=t.disabled,j(t,e),e}var o={buildAttributePayload:C,findClosestReflex:S,findClosestFrame:k,findFrameId:F,findFrame:O,findFrameSrc:I,get metaElement(){return document.getElementById("turbo-reflex")},get metaElementToken(){return document.getElementById("turbo-reflex").getAttribute("content")}};var v={};addEventListener("turbo:before-fetch-request",t=>{let e=t.target.closest("turbo-frame"),r=o.metaElement.detail||{};if(e!=r.frame)return;let{fetchOptions:n}=t.detail;n.headers["TurboReflex-Token"]=o.metaElementToken});addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame");e&&(v[e.id]=e.src);let r=o.metaElement.detail||{};e==r.frame&&(delete o.metaElement.dataset.busy,delete o.metaElement.detail,s.dispatch(s.events.finish,r.element||document,r))});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.turboReflexSrc=v[e.id]||e.src||e.dataset.turboReflexSrc,delete v[e.id]});var b={},y;function A(t,e){b[t]=e,document.addEventListener(t,y,!0)}function H(t,e){return e=e.toLowerCase(),b[t].includes(e)||!Object.values(b).flat().includes(e)&&b[t].includes("*")}var f={events:b,register:A,isRegistered:H,set handler(t){y=t}};function P(t,e={}){e.token=o.metaElementToken;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(e),t.appendChild(r)}var L={invokeReflex:P};function D(t){let e=document.createElement("a");return e.href=t,new URL(e)}var x={build:D};function q(t,e){let r=o.findFrameSrc(t);if(!r)return;let n=x.build(r);n.searchParams.set("turbo_reflex",JSON.stringify(e)),t.src=n.toString()}var w={invokeReflex:q};function h(t,e={}){e={...o.metaElement.detail,...e};let r=e.element||document;delete o.metaElement.dataset.busy,delete o.metaElement.detail,s.dispatch(t,r,e),s.dispatch(s.events.finish,r,e)}function B(t){h(s.events.abort)}function R(t){let e=t.target,{status:r,statusText:n}=e,c={...t.detail,responseStatus:r,responseStatusText:n,responseText:e.responseText};h(s.events.error,c)}function J(t){let e=t.target;if(!(e.status>=200&&e.status<=299))return R(t);let n=e.responseText;if(e.getResponseHeader("TurboReflex-Hijacked")==="true"){let a="<turbo-stream",l="</turbo-stream>",u=n.indexOf(a),d=n.lastIndexOf(l);if(u>=0&&d>=0){let p=n.slice(u,d+l.length);document.body.insertAdjacentHTML("beforeend",p)}}else{let a="<html",l="</html",u=n.indexOf(a),d=n.lastIndexOf(l);if(u>=0&&d>=0){let p=n.slice(n.indexOf(">",u)+1,d);document.documentElement.innerHTML=p}}h(s.events.success)}function M(t){let e=x.build(window.location.href);e.searchParams.set("turbo_reflex",JSON.stringify(t));let r=new XMLHttpRequest;r.open("GET",e,!0),r.setRequestHeader("TurboReflex-Token",o.metaElementToken),r.addEventListener("abort",B),r.addEventListener("error",R),r.addEventListener("load",J),r.send()}var T={invokeReflex:M};var g={form:L,frame:w,window:T};function _(t){let e,r={};try{if(e=o.findClosestReflex(t.target),!e||!f.isRegistered(t.type,e.tagName))return;s.dispatch(s.events.beforeStart,e);let n=o.findFrameId(e),c;if(n&&(c=o.findFrame(n),!c))return;let a="window";c&&(a="frame"),e.tagName.toLowerCase()==="form"&&(a="form");let l={driver:a,element:o.buildAttributePayload(e)};r={...l,frame:c,element:e},o.metaElement.dataset.busy=!0,o.metaElement.detail=r,s.dispatch(s.events.start,e,r),a!=="form"&&t.preventDefault(),a==="frame"&&g.frame.invokeReflex(c,l),a==="window"&&g.window.invokeReflex(l),a==="form"&&g.form.invokeReflex(e,l)}catch(n){s.dispatch(s.events.error,e||document,{...r,error:n})}}f.handler=_;f.register("change",["input","select","textarea"]);f.register("submit",["form"]);f.register("click",["*"]);var xe={registerEvent:f.register,get registeredEvents(){return{...f.events}},get lifecycleEvents(){return[...Object.values(s.events)]},get logLevel(){return s.logLevel},set logLevel(t){return s.logLevel=t}};export{xe as default};
//# sourceMappingURL=turbo_reflex.js.map
