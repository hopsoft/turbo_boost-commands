var g=class{get element(){return document.querySelector('meta[name="turbo-reflex"]')}get token(){return this.element.getAttribute("content")}get busy(){return this.element.dataset.busy==="true"}set busy(e){return this.element.dataset.busy=!!e}get uiState(){return this.element.dataset.uiState}get uiStateChunks(){let e=this.element.dataset.uiState,r=new Blob([e]).size,n=Math.ceil(r/3e3),s=Math.ceil(e.length/n),v=new RegExp(`.{1,${s}}`,"g");return e.match(v)}},i=new g;function j(t){let e="<html",r="</html",n=t.indexOf(e),s=t.lastIndexOf(r);if(n>=0&&s>=0){let v=t.slice(t.indexOf(">",n)+1,s);document.documentElement.innerHTML=v}}function q(t){document.body.insertAdjacentHTML("beforeend",t)}var l={append:q,replaceDocument:j};var x={};function H(t){x[t.id]=t}function X(t){delete x[t]}var b={add:H,remove:X,get reflexes(){return[...Object.values(x)]},get length(){return Object.keys(x).length}};var f={start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error"};function p(t,e=document,r={},n=!1){try{e=e||document;let s=new CustomEvent(t,{detail:r,cancelable:!1,bubbles:!0});e.dispatchEvent(s)}catch(s){if(n)throw s;p(f.clientError,e,{error:s,...r},!0)}}function N(t={}){p(f.clientError,window,t,!0)}function T(t){t.detail.endedAt=new Date().getTime(),t.detail.milliseconds=t.detail.endedAt-t.detail.startedAt,setTimeout(()=>p(f.finish,t.target,t.detail),20)}addEventListener(f.serverError,T);addEventListener(f.success,T);addEventListener(f.finish,t=>b.remove(t.detail.id),!0);var o={dispatch:p,dispatchClientError:N,events:f};var R={};addEventListener("turbo:before-fetch-request",t=>{let e=t.target.closest("turbo-frame"),{fetchOptions:r}=t.detail;if(i.busy){let n=["text/vnd.turbo-reflex.html",r.headers.Accept];n=n.filter(s=>s&&s.trim().length>0).join(", "),r.headers.Accept=n}r.headers["TurboReflex-Token"]=i.token,i.uiStateChunks.forEach((n,s)=>r.headers[`TurboReflex-UiState-${s.toString().padStart(6,"0")}`]=n)});addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame"),{fetchResponse:r}=t.detail;if(e&&(R[e.id]=e.src),r.header("TurboReflex")){if(r.statusCode<200||r.statusCode>399){let n=`Server returned a ${r.statusCode} status code! TurboReflex requires 2XX-3XX status codes.`;o.dispatchClientError({...t.detail,error:n})}r.header("TurboReflex")==="Append"&&(t.preventDefault(),r.responseText.then(n=>l.append(n)))}});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.turboReflexSrc=R[e.id]||e.src||e.dataset.turboReflexSrc,delete R[e.id]});var I={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",reflexAttribute:"data-turbo-reflex"},a={...I};var h={},w;function _(t,e){h[t]=e,document.addEventListener(t,w,!0)}function F(t){return Object.keys(h).find(e=>!!h[e].find(r=>Array.from(document.querySelectorAll(r)).find(n=>n===t)))}function M(t,e){return t===F(e)}var u={events:h,register:_,isRegisteredForElement:M,set handler(t){w=t}};function P(t){return t.closest(`[${a.reflexAttribute}]`)}function U(t){return t.closest("turbo-frame")}function z(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value||null;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,n)=>(n.selected&&r.push(n.value),r),[])}function B(t){let e=Array.from(t.attributes).reduce((r,n)=>{let s=n.value;return r[n.name]=s,r},{});return e.tag=t.tagName,e.checked=!!t.checked,e.disabled=!!t.disabled,z(t,e),delete e.class,delete e.action,delete e.href,delete e[a.reflexAttribute],delete e[a.frameAttribute],e}var d={buildAttributePayload:B,findClosestReflex:P,findClosestFrame:U};function J(t,e={}){e.token=i.token;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(e),t.appendChild(r)}var y={invokeReflex:J};function V(t,e={}){let r=document.createElement("a");r.href=t;let n=new URL(r);return n.searchParams.set("turbo_reflex",JSON.stringify(e)),n}var c={build:V};function G(t,e){let r=e.src;e={...e},delete e.src,t.src=c.build(r,e)}var E={invokeReflex:G};function K(t,e={}){let r=e.src;e={...e},delete e.src,delete e.href,t.setAttribute("href",c.build(r,e))}var S={invokeReflex:K};function Q(t){let e=t.target;o.dispatch(o.events.abort,window,{xhr:e,...t.detail})}function k(t){let e=t.target;e.getResponseHeader("TurboReflex")==="Append"?l.append(e.responseText):l.replaceDocument(e.responseText);let r=`Server returned a ${e.status} status code! TurboReflex requires 2XX-3XX status codes.`;o.dispatchClientError({xhr:e,...t.detail,error:r})}function W(t){let e=t.target;if(e.status<200||e.status>399)return k(t);let r=e.responseText;e.getResponseHeader("TurboReflex")==="Append"?l.append(e.responseText):l.replaceDocument(e.responseText)}function Y(t){let e=t.src;t={...t},delete t.src;try{let r=new XMLHttpRequest;r.open("GET",c.build(e,t),!0),r.setRequestHeader("Accept","text/vnd.turbo-reflex.html, text/html, application/xhtml+xml"),r.setRequestHeader("TurboReflex-Token",i.token),i.uiStateChunks.forEach((n,s)=>fetchOptions.headers[`TurboReflex-UiState-${s.toString().padStart(6,"0")}`]=n),r.addEventListener("abort",Q),r.addEventListener("error",k),r.addEventListener("load",W),r.send()}catch(r){let n=`Unexpected error sending HTTP request! ${r.message}`;k(r,{detail:{message:n}})}}var L={invokeReflex:Y};function A(t,e){return e=e||{dataset:{}},t.href||e.src||e.dataset.turboReflexSrc||location.href}function Z(t){let e=d.findClosestFrame(t),{turboFrame:r,turboMethod:n}=t.dataset;return t.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:e,src:t.action,invokeReflex:y.invokeReflex}:n&&n.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:e,src:t.href,invokeReflex:S.invokeReflex}:r&&r!=="_self"?(e=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:e,src:A(t,e),invokeReflex:E.invokeReflex}):(!r||r==="_self")&&e?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:e,src:A(t,e),invokeReflex:E.invokeReflex}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:A(t),invokeReflex:L.invokeReflex}}var O={find:Z};var m="unknown",C={debug:Object.values(o.events),info:Object.values(o.events),warn:[o.events.abort,o.events.clientError,o.events.serverError],error:[o.events.clientError,o.events.serverError],unknown:[]};Object.values(o.events).forEach(t=>{addEventListener(t,e=>{C[m].includes(e.type)&&console[m==="debug"?"log":m](e.type,e.detail)})});var D={get level(){return m},set level(t){return Object.keys(C).includes(t)||(t="unknown"),m=t}};function ee(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}var $={v4:ee};function te(t){let e,r={};try{if(e=d.findClosestReflex(t.target),!e||!u.isRegisteredForElement(t.type,e))return;let n=O.find(e);switch(r={id:`reflex-${$.v4()}`,name:e.dataset.turboReflex,driver:n.name,src:n.src,frameId:n.frame?n.frame.id:null,elementId:e.id.length>0?e.id:null,elementAttributes:d.buildAttributePayload(e),startedAt:new Date().getTime()},b.add(r),o.dispatch(o.events.start,e,r),["frame","window"].includes(n.name)&&t.preventDefault(),i.busy=!0,setTimeout(()=>i.busy=!1,10),n.name){case"method":return n.invokeReflex(e,r);case"form":return n.invokeReflex(e,r);case"frame":return n.invokeReflex(n.frame,r);case"window":return n.invokeReflex(r)}}catch(n){o.dispatch(o.events.clientError,e,{error:n,...r})}}u.handler=te;u.register("change",[`input[${a.reflexAttribute}]`,`select[${a.reflexAttribute}]`,`textarea[${a.reflexAttribute}]`]);u.register("submit",[`form[${a.reflexAttribute}]`]);u.register("click",[`[${a.reflexAttribute}]`]);var Ke={schema:a,logger:D,registerEventDelegate:u.register,get eventDelegates(){return{...u.events}},get lifecycleEvents(){return[...Object.values(o.events)]}};export{Ke as default};
//# sourceMappingURL=turbo_reflex.js.map
