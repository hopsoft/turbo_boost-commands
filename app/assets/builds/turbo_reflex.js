var L=class{get element(){return document.querySelector('meta[name="turbo-reflex"]')}get token(){return this.element.getAttribute("content")}get busy(){return this.element.dataset.busy==="true"}set busy(t){return this.element.dataset.busy=!!t}},s=new L;var u={start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error"},f={stateLoad:"turbo-reflex:state-load",stateChange:"turbo-reflex:state-change"},i={...u,...f};function a(e,t=document,r={},n=!1){try{t=t||document;let o=new CustomEvent(e,{detail:r,cancelable:!1,bubbles:!0});t.dispatchEvent(o)}catch(o){if(n)throw o;a(u.clientError,t,{error:o,...r},!0)}}var S;function E(e,t=null){if(!e||typeof e!="object")return e;let r=new Proxy(e,{deleteProperty(n,o){return delete n[o],a(f.stateChange,s.element,{state:S}),!0},set(n,o,A,me){return n[o]=E(A,this),a(f.stateChange,s.element,{state:S}),!0}});if(Array.isArray(e))e.forEach((n,o)=>e[o]=E(n,r));else if(typeof e=="object")for(let[n,o]of Object.entries(e))e[n]=E(o,r);return t||(S=r),r}var N=E;var w,m,R,q;function H(){if(!s.element)return b();let e=atob(s.element.dataset.state);R={},m=N(JSON.parse(e)),w={...m},delete s.element.dataset.clientStateChange,setTimeout(()=>a(f.stateLoad,s.element,{state:m}))}function b(){clearTimeout(q),q=setTimeout(H,10)}w||H();addEventListener("DOMContentLoaded",b);addEventListener("load",b);addEventListener("turbo:load",b);addEventListener("turbo:frame-load",b);addEventListener("turbo-reflex:success",b);addEventListener(f.stateChange,e=>{R={};for(let[t,r]of Object.entries(m))w[t]!==r&&(R[t]=r);s.element.dataset.clientStateChange=!0,s.element.dataset.state=btoa(JSON.stringify(m))});var p={events:f,get current(){return m},get delta(){return R},get payloadChunks(){return btoa(JSON.stringify(m)).match(/.{1,2000}/g)}};function V(e){let t="<html",r="</html",n=e.indexOf(t),o=e.lastIndexOf(r);if(n>=0&&o>=0){let A=e.slice(e.indexOf(">",n)+1,o);document.documentElement.innerHTML=A}}function B(e){document.body.insertAdjacentHTML("beforeend",e)}var x={append:B,replaceDocument:V};var k={};function G(e){k[e.id]=e}function z(e){delete k[e]}var y={add:G,remove:z,get reflexes(){return[...Object.values(k)]},get length(){return Object.keys(k).length}};function X(e){e.detail.endedAt=new Date().getTime(),e.detail.milliseconds=e.detail.endedAt-e.detail.startedAt,setTimeout(()=>a(u.finish,e.target,e.detail),20)}addEventListener(u.serverError,X);addEventListener(u.success,X);addEventListener(u.finish,e=>y.remove(e.detail.id),!0);var d={events:u};var O={};addEventListener("turbo:before-fetch-request",e=>{let t=e.target.closest("turbo-frame"),{fetchOptions:r}=e.detail;if(s.busy){let n=["text/vnd.turbo-reflex.html",r.headers.Accept];n=n.filter(o=>o&&o.trim().length>0).join(", "),r.headers.Accept=n,r.headers["TurboReflex-Token"]=s.token}p.payloadChunks.forEach((n,o)=>{r.headers[`TurboReflex-State-${o.toString().padStart(4,"0")}`]=n})});addEventListener("turbo:before-fetch-response",e=>{let t=e.target.closest("turbo-frame"),{fetchResponse:r}=e.detail;if(t&&(O[t.id]=t.src),r.header("TurboReflex")){if(r.statusCode<200||r.statusCode>399){let n=`Server returned a ${r.statusCode} status code! TurboReflex requires 2XX-3XX status codes.`;a(d.events.clientError,document,{...e.detail,error:n},!0)}r.header("TurboReflex")==="Append"&&(e.preventDefault(),r.responseText.then(n=>x.append(n)))}});addEventListener("turbo:frame-load",e=>{let t=e.target.closest("turbo-frame");t.dataset.turboReflexSrc=O[t.id]||t.src||t.dataset.turboReflexSrc,delete O[t.id]});var K={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",reflexAttribute:"data-turbo-reflex"},l={...K};var T={},I;function Q(e,t){T[e]=t,document.addEventListener(e,I,!0)}function W(e){return Object.keys(T).find(t=>!!T[t].find(r=>Array.from(document.querySelectorAll(r)).find(n=>n===e)))}function Y(e,t){return e===W(t)}var c={events:T,register:Q,isRegisteredForElement:Y,set handler(e){I=e}};function Z(e){return e.closest(`[${l.reflexAttribute}]`)}function ee(e){return e.closest("turbo-frame")}function te(e,t={}){if(e.tagName.toLowerCase()!=="select")return t.value=e.value||null;if(!e.multiple)return t.value=e.options[e.selectedIndex].value;t.values=Array.from(e.options).reduce((r,n)=>(n.selected&&r.push(n.value),r),[])}function re(e){let t=Array.from(e.attributes).reduce((r,n)=>{let o=n.value;return r[n.name]=o,r},{});return t.tag=e.tagName,t.checked=!!e.checked,t.disabled=!!e.disabled,te(e,t),delete t.class,delete t.action,delete t.href,delete t[l.reflexAttribute],delete t[l.frameAttribute],t}var v={buildAttributePayload:re,findClosestReflex:Z,findClosestFrame:ee};function ne(e,t={}){t.token=s.token;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(t),e.appendChild(r)}var P={invokeReflex:ne};function oe(e,t={}){let r=document.createElement("a");r.href=e;let n=new URL(r);return n.searchParams.set("turbo_reflex",JSON.stringify(t)),n}var h={build:oe};function se(e,t){let r=t.src;t={...t},delete t.src,e.src=h.build(r,t)}var C={invokeReflex:se};function ae(e,t={}){let r=t.src;t={...t},delete t.src,delete t.href,e.setAttribute("href",h.build(r,t))}var _={invokeReflex:ae};function ie(e){let t=e.target;a(d.events.abort,document,{xhr:t,...e.detail})}function D(e){let t=e.target;t.getResponseHeader("TurboReflex")==="Append"?x.append(t.responseText):x.replaceDocument(t.responseText);let r=`Server returned a ${t.status} status code! TurboReflex requires 2XX-3XX status codes.`;a(d.events.clientError,document,{xhr:t,...e.detail,error:r},!0)}function le(e){let t=e.target;if(t.status<200||t.status>399)return D(e);let r=t.responseText;t.getResponseHeader("TurboReflex")==="Append"?x.append(t.responseText):x.replaceDocument(t.responseText)}function ue(e){let t=e.src;e={...e},delete e.src;try{let r=new XMLHttpRequest;r.open("GET",h.build(t,e),!0),r.setRequestHeader("Accept","text/vnd.turbo-reflex.html, text/html, application/xhtml+xml"),r.setRequestHeader("TurboReflex-Token",s.token),p.payloadChunks.forEach((n,o)=>r.setRequestHeader(`TurboReflex-State-${o.toString().padStart(4,"0")}`,n)),r.addEventListener("abort",ie),r.addEventListener("error",D),r.addEventListener("load",le),r.send()}catch(r){let n=`Unexpected error sending HTTP request! ${r.message}`;D(r,{detail:{message:n}})}}var F={invokeReflex:ue};function $(e,t){return t=t||{dataset:{}},e.href||t.src||t.dataset.turboReflexSrc||location.href}function fe(e){let t=v.findClosestFrame(e),{turboFrame:r,turboMethod:n}=e.dataset;return e.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:t,src:e.action,invokeReflex:P.invokeReflex}:n&&n.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:t,src:e.href,invokeReflex:_.invokeReflex}:r&&r!=="_self"?(t=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:t,src:$(e,t),invokeReflex:C.invokeReflex}):(!r||r==="_self")&&t?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:t,src:$(e,t),invokeReflex:C.invokeReflex}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:$(e),invokeReflex:F.invokeReflex}}var j={find:fe};var g="unknown",J={debug:Object.values(i),info:Object.values(i),warn:[i.abort,i.clientError,i.serverError],error:[i.clientError,i.serverError],unknown:[]};Object.values(i).forEach(e=>{addEventListener(e,t=>{J[g].includes(t.type)&&console[g==="debug"?"log":g](t.type,{target:t.target,detail:t.detail})})});var M={get level(){return g},set level(e){return Object.keys(J).includes(e)||(e="unknown"),g=e}};function de(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var U={v4:de};function ce(e){let t,r={};try{if(t=v.findClosestReflex(e.target),!t||!c.isRegisteredForElement(e.type,t))return;let n=j.find(t);switch(r={id:`reflex-${U.v4()}`,name:t.dataset.turboReflex,driver:n.name,src:n.src,frameId:n.frame?n.frame.id:null,elementId:t.id.length>0?t.id:null,elementAttributes:v.buildAttributePayload(t),startedAt:new Date().getTime()},y.add(r),a(d.events.start,t,r),["frame","window"].includes(n.name)&&e.preventDefault(),s.busy=!0,setTimeout(()=>s.busy=!1,10),n.name){case"method":return n.invokeReflex(t,r);case"form":return n.invokeReflex(t,r);case"frame":return n.invokeReflex(n.frame,r);case"window":return n.invokeReflex(r)}}catch(n){a(d.events.clientError,t,{error:n,...r})}}c.handler=ce;c.register("change",[`input[${l.reflexAttribute}]`,`select[${l.reflexAttribute}]`,`textarea[${l.reflexAttribute}]`]);c.register("submit",[`form[${l.reflexAttribute}]`]);c.register("click",[`[${l.reflexAttribute}]`]);var kt=self.TurboReflex={logger:M,schema:l,registerEventDelegate:c.register,get eventDelegates(){return{...c.events}},get events(){return{...i}},get state(){return p.current},get stateDelta(){return p.delta}};export{kt as default};
//# sourceMappingURL=turbo_reflex.js.map
