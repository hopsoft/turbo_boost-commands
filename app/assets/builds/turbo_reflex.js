var y=class{get element(){return document.querySelector('meta[name="turbo-reflex"]')}get token(){return this.element.getAttribute("content")}get busy(){return this.element.dataset.busy==="true"}set busy(t){return this.element.dataset.busy=!!t}},s=new y;var u={start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error"},m={stateChange:"turbo-reflex:state:change"},l={...u,...m};function a(e,t=document,r={},o=!1){try{t=t||document;let n=new CustomEvent(e,{detail:r,cancelable:!1,bubbles:!0});t.dispatchEvent(n)}catch(n){if(o)throw n;a(u.clientError,t,{error:n,...r},!0)}}var A;function C(e){return a(m.stateChange,s.element,{state:e}),!0}function h(e,t=null){if(!e||typeof e!="object")return e;let r=new Proxy(e,{deleteProperty(o,n){return delete o[n],C(A)},set(o,n,k,fe){return o[n]=h(k,this),C(A)}});if(Array.isArray(e))e.forEach((o,n)=>e[n]=h(o,r));else if(typeof e=="object")for(let[o,n]of Object.entries(e))e[o]=h(n,r);return t||(A=r),r}var D=h;var T;addEventListener("DOMContentLoaded",()=>{let e=atob(s.element.dataset.state);T=D(JSON.parse(e))});addEventListener(m.stateChange,e=>{let{state:t}=e.detail;s.element.dataset.state=btoa(JSON.stringify(t))});var v={events:m,get payloadChunks(){return s.element.dataset.state.match(/.{1,2000}/g)}};function j(e){let t="<html",r="</html",o=e.indexOf(t),n=e.lastIndexOf(r);if(o>=0&&n>=0){let k=e.slice(e.indexOf(">",o)+1,n);document.documentElement.innerHTML=k}}function J(e){document.body.insertAdjacentHTML("beforeend",e)}var c={append:J,replaceDocument:j};var g={};function M(e){g[e.id]=e}function U(e){delete g[e]}var E={add:M,remove:U,get reflexes(){return[...Object.values(g)]},get length(){return Object.keys(g).length}};function $(e){e.detail.endedAt=new Date().getTime(),e.detail.milliseconds=e.detail.endedAt-e.detail.startedAt,setTimeout(()=>a(u.finish,e.target,e.detail),20)}addEventListener(u.serverError,$);addEventListener(u.success,$);addEventListener(u.finish,e=>E.remove(e.detail.id),!0);var f={events:u};var w={};addEventListener("turbo:before-fetch-request",e=>{let t=e.target.closest("turbo-frame"),{fetchOptions:r}=e.detail;if(s.busy){let o=["text/vnd.turbo-reflex.html",r.headers.Accept];o=o.filter(n=>n&&n.trim().length>0).join(", "),r.headers.Accept=o}r.headers["TurboReflex-Token"]=s.token,v.payloadChunks.forEach((o,n)=>r.headers[`TurboReflex-State-${n.toString().padStart(4,"0")}`]=o)});addEventListener("turbo:before-fetch-response",e=>{let t=e.target.closest("turbo-frame"),{fetchResponse:r}=e.detail;if(t&&(w[t.id]=t.src),r.header("TurboReflex")){if(r.statusCode<200||r.statusCode>399){let o=`Server returned a ${r.statusCode} status code! TurboReflex requires 2XX-3XX status codes.`;a(f.events.clientError,document,{...e.detail,error:o},!0)}r.header("TurboReflex")==="Append"&&(e.preventDefault(),r.responseText.then(o=>c.append(o)))}});addEventListener("turbo:frame-load",e=>{let t=e.target.closest("turbo-frame");t.dataset.turboReflexSrc=w[t.id]||t.src||t.dataset.turboReflexSrc,delete w[t.id]});var V={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",reflexAttribute:"data-turbo-reflex"},i={...V};var R={},q;function B(e,t){R[e]=t,document.addEventListener(e,q,!0)}function G(e){return Object.keys(R).find(t=>!!R[t].find(r=>Array.from(document.querySelectorAll(r)).find(o=>o===e)))}function z(e,t){return e===G(t)}var d={events:R,register:B,isRegisteredForElement:z,set handler(e){q=e}};function K(e){return e.closest(`[${i.reflexAttribute}]`)}function Q(e){return e.closest("turbo-frame")}function W(e,t={}){if(e.tagName.toLowerCase()!=="select")return t.value=e.value||null;if(!e.multiple)return t.value=e.options[e.selectedIndex].value;t.values=Array.from(e.options).reduce((r,o)=>(o.selected&&r.push(o.value),r),[])}function Y(e){let t=Array.from(e.attributes).reduce((r,o)=>{let n=o.value;return r[o.name]=n,r},{});return t.tag=e.tagName,t.checked=!!e.checked,t.disabled=!!e.disabled,W(e,t),delete t.class,delete t.action,delete t.href,delete t[i.reflexAttribute],delete t[i.frameAttribute],t}var x={buildAttributePayload:Y,findClosestReflex:K,findClosestFrame:Q};function Z(e,t={}){t.token=s.token;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(t),e.appendChild(r)}var H={invokeReflex:Z};function ee(e,t={}){let r=document.createElement("a");r.href=e;let o=new URL(r);return o.searchParams.set("turbo_reflex",JSON.stringify(t)),o}var p={build:ee};function te(e,t){let r=t.src;t={...t},delete t.src,e.src=p.build(r,t)}var L={invokeReflex:te};function re(e,t={}){let r=t.src;t={...t},delete t.src,delete t.href,e.setAttribute("href",p.build(r,t))}var N={invokeReflex:re};function oe(e){let t=e.target;a(f.events.abort,document,{xhr:t,...e.detail})}function O(e){let t=e.target;t.getResponseHeader("TurboReflex")==="Append"?c.append(t.responseText):c.replaceDocument(t.responseText);let r=`Server returned a ${t.status} status code! TurboReflex requires 2XX-3XX status codes.`;a(f.events.clientError,document,{xhr:t,...e.detail,error:r},!0)}function ne(e){let t=e.target;if(t.status<200||t.status>399)return O(e);let r=t.responseText;t.getResponseHeader("TurboReflex")==="Append"?c.append(t.responseText):c.replaceDocument(t.responseText)}function se(e){let t=e.src;e={...e},delete e.src;try{let r=new XMLHttpRequest;r.open("GET",p.build(t,e),!0),r.setRequestHeader("Accept","text/vnd.turbo-reflex.html, text/html, application/xhtml+xml"),r.setRequestHeader("TurboReflex-Token",s.token),v.payloadChunks.forEach((o,n)=>r.setRequestHeader(`TurboReflex-State-${n.toString().padStart(4,"0")}`,o)),r.addEventListener("abort",oe),r.addEventListener("error",O),r.addEventListener("load",ne),r.send()}catch(r){let o=`Unexpected error sending HTTP request! ${r.message}`;O(r,{detail:{message:o}})}}var X={invokeReflex:se};function S(e,t){return t=t||{dataset:{}},e.href||t.src||t.dataset.turboReflexSrc||location.href}function ae(e){let t=x.findClosestFrame(e),{turboFrame:r,turboMethod:o}=e.dataset;return e.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:t,src:e.action,invokeReflex:H.invokeReflex}:o&&o.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:t,src:e.href,invokeReflex:N.invokeReflex}:r&&r!=="_self"?(t=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:t,src:S(e,t),invokeReflex:L.invokeReflex}):(!r||r==="_self")&&t?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:t,src:S(e,t),invokeReflex:L.invokeReflex}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:S(e),invokeReflex:X.invokeReflex}}var I={find:ae};var b="unknown",P={debug:Object.values(l),info:Object.values(l),warn:[l.abort,l.clientError,l.serverError],error:[l.clientError,l.serverError],unknown:[]};Object.values(l).forEach(e=>{addEventListener(e,t=>{P[b].includes(t.type)&&console[b==="debug"?"log":b](t.type,t.detail)})});var _={get level(){return b},set level(e){return Object.keys(P).includes(e)||(e="unknown"),b=e}};function ie(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var F={v4:ie};function le(e){let t,r={};try{if(t=x.findClosestReflex(e.target),!t||!d.isRegisteredForElement(e.type,t))return;let o=I.find(t);switch(r={id:`reflex-${F.v4()}`,name:t.dataset.turboReflex,driver:o.name,src:o.src,frameId:o.frame?o.frame.id:null,elementId:t.id.length>0?t.id:null,elementAttributes:x.buildAttributePayload(t),startedAt:new Date().getTime()},E.add(r),a(f.events.start,t,r),["frame","window"].includes(o.name)&&e.preventDefault(),s.busy=!0,setTimeout(()=>s.busy=!1,10),o.name){case"method":return o.invokeReflex(t,r);case"form":return o.invokeReflex(t,r);case"frame":return o.invokeReflex(o.frame,r);case"window":return o.invokeReflex(r)}}catch(o){a(f.events.clientError,t,{error:o,...r})}}d.handler=le;d.register("change",[`input[${i.reflexAttribute}]`,`select[${i.reflexAttribute}]`,`textarea[${i.reflexAttribute}]`]);d.register("submit",[`form[${i.reflexAttribute}]`]);d.register("click",[`[${i.reflexAttribute}]`]);var vt=self.TurboReflex={logger:_,schema:i,registerEventDelegate:d.register,get eventDelegates(){return{...d.events}},get lifecycleEvents(){return[...Object.values(f.events)]},get state(){return T}};export{vt as default};
//# sourceMappingURL=turbo_reflex.js.map
