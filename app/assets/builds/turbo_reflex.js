var v={};function A(e){v[e.id]=e}function C(e){delete v[e]}var x={add:A,remove:C,get reflexes(){return[...Object.values(v)]},get length(){return Object.keys(v).length}};var c={beforeStart:"turbo-reflex:before-start",start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error",missingFrame:"turbo-reflex:missing-frame",missingFrameSrc:"turbo-reflex:missing-frame-src"};function E(e,t=document,r={},s=!1){try{t=t||document;let a=new CustomEvent(e,{detail:r,cancelable:!1,bubbles:!0});t.dispatchEvent(a)}catch(a){if(s)throw a;E(c.clientError,t,{error:a,...r},!0)}}function k(e){e.detail.endedAt=new Date().getTime(),e.detail.milliseconds=e.detail.endedAt-e.detail.startedAt,setTimeout(()=>E(c.finish,e.target,e.detail),10)}addEventListener(c.serverError,k);addEventListener(c.success,k);addEventListener(c.finish,e=>x.remove(e.detail.id),!0);var n={dispatch:E,events:c};function D(e){return e.closest("[data-turbo-reflex]")}function w(e){return e.closest("turbo-frame")}function H(e){let t=e.dataset.turboFrame;if(!t){let r=w(e);r&&(t=r.id)}return t}function P(e){let t=document.getElementById(e);if(!t){let r=`The frame '${e}' does not exist!`;n.dispatch(n.events.missingFrame,document,{message:r})}return t}function $(e){let t=e.dataset.turboReflexSrc||e.src;if(!t){let r=`The the 'src' for <turbo-frame id='${e.id}'> is unknown!
      TurboReflex uses 'src' to (re)render frame content after the reflex is invoked.
      Please set the 'src' or 'data-turbo-reflex-src' attribute on the <turbo-frame> element.`;n.dispatch(n.events.missingFrameSrc,e,{message:r})}return t}function q(e,t={}){if(e.tagName.toLowerCase()!=="select")return t.value=e.value;if(!e.multiple)return t.value=e.options[e.selectedIndex].value;t.values=Array.from(e.options).reduce((r,s)=>(s.selected&&r.push(s.value),r),[])}function B(e){let t=Array.from(e.attributes).reduce((r,s)=>(r[s.name]=s.value,r),{});return t.tag=e.tagName,t.checked=e.checked,t.disabled=e.disabled,q(e,t),t}var o={buildAttributePayload:B,findClosestReflex:D,findClosestFrame:w,findFrameId:H,findFrame:P,findFrameSrc:$,get metaElement(){return document.getElementById("turbo-reflex")},get metaElementToken(){return document.getElementById("turbo-reflex").getAttribute("content")}};var y={};addEventListener("turbo:before-fetch-request",e=>{let t=e.target.closest("turbo-frame"),{fetchOptions:r}=e.detail;r.headers["TurboReflex-Token"]=o.metaElementToken});addEventListener("turbo:before-fetch-response",e=>{let t=e.target.closest("turbo-frame");t&&(y[t.id]=t.src)});addEventListener("turbo:frame-load",e=>{let t=e.target.closest("turbo-frame");t.dataset.turboReflexSrc=y[t.id]||t.src||t.dataset.turboReflexSrc,delete y[t.id]});var u={},R;function J(e,t){u[e]=t,document.addEventListener(e,R,!0)}function M(e,t){return t=t.toLowerCase(),u[e].includes(t)||!Object.values(u).flat().includes(t)&&u[e].includes("*")}var l={events:u,register:J,isRegistered:M,set handler(e){R=e}};function _(e,t={}){t.token=o.metaElementToken;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(t),e.appendChild(r)}var L={invokeReflex:_};function N(e){let t=document.createElement("a");return t.href=e,new URL(t)}var g={build:N};function U(e,t){let r=o.findFrameSrc(e);if(!r)return;let s=g.build(r);s.searchParams.set("turbo_reflex",JSON.stringify(t)),e.src=s.toString()}var T={invokeReflex:U};function V(e){let t=e.target;dispatch(n.events.abort,t,{...e.detail})}function S(e){let t=e.target;dispatch(n.events.clientError,t,{...e.detail,error:`Server returned a ${t.status} status code! ${t.statusText}`},!0)}function G(e){let t=e.target;if(!(t.status>=200&&t.status<=299))return S(e);let s=t.responseText;if(t.getResponseHeader("TurboReflex-Hijacked")==="true"){let i="<turbo-stream",b="</turbo-stream>",f=s.indexOf(i),d=s.lastIndexOf(b);if(f>=0&&d>=0){let h=s.slice(f,d+b.length);document.body.insertAdjacentHTML("beforeend",h)}}else{let i="<html",b="</html",f=s.indexOf(i),d=s.lastIndexOf(b);if(f>=0&&d>=0){let h=s.slice(s.indexOf(">",f)+1,d);document.documentElement.innerHTML=h}}}function X(e){let t=g.build(window.location.href);t.searchParams.set("turbo_reflex",JSON.stringify(e));let r=new XMLHttpRequest;r.open("GET",t,!0),r.setRequestHeader("TurboReflex-Token",o.metaElementToken),r.addEventListener("abort",V),r.addEventListener("error",S),r.addEventListener("load",G),r.send()}var O={invokeReflex:X};var p={form:L,frame:T,window:O};var m="unknown",F={debug:Object.values(n.events),info:Object.values(n.events),warn:[n.events.abort,n.events.clientError,n.events.missingFrame,n.events.missingFrameSrc,n.events.serverError],error:[n.events.clientError,n.events.missingFrame,n.events.missingFrameSrc,n.events.serverError],unknown:[]};Object.values(n.events).forEach(e=>{addEventListener(e,t=>{F[m].includes(t.type)&&console[m==="debug"?"log":m](t.type,t.detail)})});var I={get level(){return m},set level(e){return Object.keys(F).includes(e)||(e="unknown"),m=e}};function z(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var j={v4:z};function K(e){let t;try{if(t=o.findClosestReflex(e.target),!t||!l.isRegistered(e.type,t.tagName))return;let r={id:`reflex-${j.v4()}`,name:t.dataset.turboReflex,driver:null,frameId:null,elementId:t.id.length>0?t.id:null,elementAttributes:o.buildAttributePayload(t)};x.add(r),n.dispatch(n.events.beforeStart,t,r);let s=o.findFrameId(t);r.frameId=s;let a;if(s&&(a=o.findFrame(s),!a))return;let i="window";a&&(i="frame"),t.tagName.toLowerCase()==="form"&&(i="form"),r.driver=i,r.startedAt=new Date().getTime(),n.dispatch(n.events.start,t,r),i!=="form"&&e.preventDefault(),i==="frame"&&p.frame.invokeReflex(a,r),i==="window"&&p.window.invokeReflex(r),i==="form"&&p.form.invokeReflex(t,r)}catch(r){n.dispatch(n.events.clientError,t,{error:r,...payload})}}l.handler=K;l.register("change",["input","select","textarea"]);l.register("submit",["form"]);l.register("click",["*"]);var Ie={logger:I,registerEventDelegate:l.register,get eventDelegates(){return{...l.events}},get lifecycleEvents(){return[...Object.values(n.events)]}};export{Ie as default};
//# sourceMappingURL=turbo_reflex.js.map
