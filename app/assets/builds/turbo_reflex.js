var j={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",reflexAttribute:"data-turbo-reflex"},i={...j};var m={};function S(e){m[e.id]=e}function $(e){delete m[e]}var x={add:S,remove:$,get reflexes(){return[...Object.values(m)]},get length(){return Object.keys(m).length}};var f={start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error"};function p(e,t=document,r={},n=!1){try{t=t||document;let s=new CustomEvent(e,{detail:r,cancelable:!1,bubbles:!0});t.dispatchEvent(s)}catch(s){if(n)throw s;p(f.clientError,t,{error:s,...r},!0)}}function H(e={}){p(f.clientError,window,e,!0)}function R(e){e.detail.endedAt=new Date().getTime(),e.detail.milliseconds=e.detail.endedAt-e.detail.startedAt,setTimeout(()=>p(f.finish,e.target,e.detail),20)}addEventListener(f.serverError,R);addEventListener(f.success,R);addEventListener(f.finish,e=>x.remove(e.detail.id),!0);var o={dispatch:p,dispatchClientError:H,events:f};function I(e){return e.closest(`[${i.reflexAttribute}]`)}function q(e){return e.closest("turbo-frame")}function N(e,t={}){if(e.tagName.toLowerCase()!=="select")return t.value=e.value;if(!e.multiple)return t.value=e.options[e.selectedIndex].value;t.values=Array.from(e.options).reduce((r,n)=>(n.selected&&r.push(n.value),r),[])}function X(e){let t=Array.from(e.attributes).reduce((r,n)=>{let s=n.value;return r[n.name]=s,r},{});return t.tag=e.tagName,t.checked=e.checked,t.disabled=e.disabled,N(e,t),typeof t.value=="string"&&t.value.length>maxValueLength&&(t.value=t.value.slice(0,maxValueLength)+"..."),delete t.class,delete t[i.reflexAttribute],delete t[i.frameAttribute],t}var l={buildAttributePayload:X,findClosestReflex:I,findClosestFrame:q,get metaElement(){return document.getElementById("turbo-reflex")},get metaElementToken(){return document.getElementById("turbo-reflex").getAttribute("content")}};function _(e){let t="<html",r="</html",n=e.indexOf(t),s=e.lastIndexOf(r);if(n>=0&&s>=0){let D=e.slice(e.indexOf(">",n)+1,s);document.documentElement.innerHTML=D}}function F(e){document.body.insertAdjacentHTML("beforeend",e)}var u={append:F,replaceDocument:_};var v={};addEventListener("turbo:before-fetch-request",e=>{let t=e.target.closest("turbo-frame"),{fetchOptions:r}=e.detail;if(window.turboReflexActive){let n=["text/vnd.turbo-reflex.html",r.headers.Accept];n=n.filter(s=>s&&s.trim().length>0).join(", "),r.headers.Accept=n,r.headers["TurboReflex-Token"]=l.metaElementToken}});addEventListener("turbo:before-fetch-response",e=>{let t=e.target.closest("turbo-frame"),{fetchResponse:r}=e.detail;if(t&&(v[t.id]=t.src),r.header("TurboReflex")){if(r.statusCode<200||r.statusCode>399){let n=`Server returned a ${r.statusCode} status code! TurboReflex requires 2XX-3XX status codes.`;o.dispatchClientError({...e.detail,error:n})}r.header("TurboReflex")==="Append"&&(e.preventDefault(),r.responseText.then(n=>u.append(n)))}});addEventListener("turbo:frame-load",e=>{let t=e.target.closest("turbo-frame");t.dataset.turboReflexSrc=v[t.id]||t.src||t.dataset.turboReflexSrc,delete v[t.id]});var b={},k;function P(e,t){b[e]=t,document.addEventListener(e,k,!0)}function M(e){return Object.keys(b).find(t=>!!b[t].find(r=>Array.from(document.querySelectorAll(r)).find(n=>n===e)))}function V(e,t){return e===M(t)}var a={events:b,register:P,isRegisteredForElement:V,set handler(e){k=e}};function B(e,t={}){t.token=l.metaElementToken;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(t),e.appendChild(r)}var A={invokeReflex:B};function U(e,t={}){let r=document.createElement("a");r.href=e;let n=new URL(r);return n.searchParams.set("turbo_reflex",JSON.stringify(t)),n}var c={build:U};function J(e,t){let r=t.src;t={...t},delete t.src,e.src=c.build(r,t)}var h={invokeReflex:J};function G(e,t={}){let r=t.src;t={...t},delete t.src,delete t.href,e.setAttribute("href",c.build(r,t))}var w={invokeReflex:G};function z(e){let t=e.target;o.dispatch(o.events.abort,window,{xhr:t,...e.detail})}function g(e){let t=e.target;t.getResponseHeader("TurboReflex")==="Append"?u.append(t.responseText):u.replaceDocument(t.responseText);let r=`Server returned a ${t.status} status code! TurboReflex requires 2XX status codes.`;o.dispatchClientError({xhr:t,...e.detail,error:r})}function K(e){let t=e.target;if(t.status<200||t.status>299)return g(e);let r=t.responseText;t.getResponseHeader("TurboReflex")==="Append"?u.append(t.responseText):u.replaceDocument(t.responseText)}function Q(e){let t=e.src;e={...e},delete e.src;try{let r=new XMLHttpRequest;r.open("GET",c.build(t,e),!0),r.setRequestHeader("Accept","text/vnd.turbo-reflex.html, text/html, application/xhtml+xml"),r.setRequestHeader("TurboReflex-Token",l.metaElementToken),r.addEventListener("abort",z),r.addEventListener("error",g),r.addEventListener("load",K),r.send()}catch(r){let n=`Unexpected error sending HTTP request! ${r.message}`;g(r,{detail:{message:n}})}}var T={invokeReflex:Q};function E(e,t){return t=t||{dataset:{}},e.href||t.src||t.dataset.turboReflexSrc||location.href}function W(e){let t=l.findClosestFrame(e),{turboFrame:r,turboMethod:n}=e.dataset;return e.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:t,src:e.action,invokeReflex:A.invokeReflex}:n&&n.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:t,src:e.href,invokeReflex:w.invokeReflex}:r&&r!=="_self"?(t=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:t,src:E(e,t),invokeReflex:h.invokeReflex}):(!r||r==="_self")&&t?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:t,src:E(e,t),invokeReflex:h.invokeReflex}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:E(e),invokeReflex:T.invokeReflex}}var L={find:W};var d="unknown",y={debug:Object.values(o.events),info:Object.values(o.events),warn:[o.events.abort,o.events.clientError,o.events.serverError],error:[o.events.clientError,o.events.serverError],unknown:[]};Object.values(o.events).forEach(e=>{addEventListener(e,t=>{y[d].includes(t.type)&&console[d==="debug"?"log":d](t.type,t.detail)})});var O={get level(){return d},set level(e){return Object.keys(y).includes(e)||(e="unknown"),d=e}};function Y(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var C={v4:Y};function Z(e){let t,r={};try{if(t=l.findClosestReflex(e.target),!t||!a.isRegisteredForElement(e.type,t))return;let n=L.find(t);switch(r={id:`reflex-${C.v4()}`,name:t.dataset.turboReflex,driver:n.name,src:n.src,frameId:n.frame?n.frame.id:null,elementId:t.id.length>0?t.id:null,elementAttributes:l.buildAttributePayload(t),startedAt:new Date().getTime()},x.add(r),o.dispatch(o.events.start,t,r),["frame","window"].includes(n.name)&&e.preventDefault(),window.turboReflexActive=!0,setTimeout(()=>window.turboReflexActive=!1,10),n.name){case"method":return n.invokeReflex(t,r);case"form":return n.invokeReflex(t,r);case"frame":return n.invokeReflex(n.frame,r);case"window":return n.invokeReflex(r)}}catch(n){o.dispatch(o.events.clientError,t,{error:n,...r})}}a.handler=Z;a.register("change",[`input[${i.reflexAttribute}]`,`select[${i.reflexAttribute}]`,`textarea[${i.reflexAttribute}]`]);a.register("submit",[`form[${i.reflexAttribute}]`]);a.register("click",[`[${i.reflexAttribute}]`]);var Ke={schema:i,logger:O,registerEventDelegate:a.register,get eventDelegates(){return{...a.events}},get lifecycleEvents(){return[...Object.values(o.events)]}};export{Ke as default};
//# sourceMappingURL=turbo_reflex.js.map
