var b={};function A(t){b[t.id]=t}function j(t){delete b[t]}var v={add:A,remove:j,get reflexes(){return[...Object.values(b)]},get length(){return Object.keys(b).length}};var d={beforeStart:"turbo-reflex:before-start",start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error",missingFrame:"turbo-reflex:missing-frame",missingFrameSrc:"turbo-reflex:missing-frame-src"};function E(t,e=document,r={},s=!1){try{e=e||document;let o=new CustomEvent(t,{detail:r,cancelable:!1,bubbles:!0});e.dispatchEvent(o)}catch(o){if(s)throw o;E(d.clientError,e,{error:o,...r},!0)}}function x(t){t.detail.endedAt=new Date().getTime(),t.detail.milliseconds=t.detail.endedAt-t.detail.startedAt,setTimeout(()=>E(d.finish,t.target,t.detail),10)}addEventListener(d.serverError,x);addEventListener(d.success,x);addEventListener(d.missingFrame,x);addEventListener(d.missingFrameSrc,x);addEventListener(d.finish,t=>v.remove(t.detail.id),!0);var n={dispatch:E,events:d};function C(t){return t.closest("[data-turbo-reflex]")}function k(t){return t.closest("turbo-frame")}function D(t){let e=t.dataset.turboFrame;if(!e){let r=k(t);r&&(e=r.id)}return e}function H(t,e=document,r={}){let s=document.getElementById(t);if(!s){e=e||document;let o=`The frame '${t}' does not exist!`;n.dispatch(n.events.missingFrame,e,{message:o,...r})}return s}function P(t,e={}){let r=t.dataset.turboReflexSrc||t.src;if(!r){let s=`The the 'src' for <turbo-frame id='${t.id}'> is unknown!
      TurboReflex uses 'src' to (re)render frame content after the reflex is invoked.
      Please set the 'src' or 'data-turbo-reflex-src' attribute on the <turbo-frame> element.`;n.dispatch(n.events.missingFrameSrc,t,{message:s,...e})}return r}function $(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,s)=>(s.selected&&r.push(s.value),r),[])}function q(t){let e=Array.from(t.attributes).reduce((r,s)=>(r[s.name]=s.value,r),{});return e.tag=t.tagName,e.checked=t.checked,e.disabled=t.disabled,$(t,e),e}var i={buildAttributePayload:q,findClosestReflex:C,findClosestFrame:k,findFrameId:D,findFrame:H,findFrameSrc:P,get metaElement(){return document.getElementById("turbo-reflex")},get metaElementToken(){return document.getElementById("turbo-reflex").getAttribute("content")}};var w={};addEventListener("turbo:before-fetch-request",t=>{let e=t.target.closest("turbo-frame"),{fetchOptions:r}=t.detail;r.headers["TurboReflex-Token"]=i.metaElementToken});addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame");e&&(w[e.id]=e.src)});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.turboReflexSrc=w[e.id]||e.src||e.dataset.turboReflexSrc,delete w[e.id]});var u={},R;function B(t,e){u[t]=e,document.addEventListener(t,R,!0)}function M(t,e){return e=e.toLowerCase(),u[t].includes(e)||!Object.values(u).flat().includes(e)&&u[t].includes("*")}var l={events:u,register:B,isRegistered:M,set handler(t){R=t}};function U(t,e={}){e.token=i.metaElementToken;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(e),t.appendChild(r)}var T={invokeReflex:U};function X(t,e={}){let r=document.createElement("a");r.href=t;let s=new URL(r);return s.searchParams.set("turbo_reflex",JSON.stringify(e)),s}var g={build:X};function J(t,e){let r=i.findFrameSrc(t,e);!r||(t.src=g.build(r,e))}var L={invokeReflex:J};function V(t){let e=t.target;n.dispatch(n.events.abort,window,{xhr:e,...t.detail})}function y(t){let e=t.target;n.dispatch(n.events.clientError,window,{xhr:e,...t.detail,error:`Server returned a ${e.status} status code! TurboReflex requires 2XX status codes. Server message: ${e.statusText}`},!0)}function _(t){let e=t.target,r=e.responseText,s=e.getResponseHeader("TurboReflex-Hijacked")==="true";if((e.status<200||e.status>299)&&y(t),s){let o="<turbo-stream",a="</turbo-stream>",f=r.indexOf(o),c=r.lastIndexOf(a);if(f>=0&&c>=0){let h=r.slice(f,c+a.length);document.body.insertAdjacentHTML("beforeend",h)}}else{let o="<html",a="</html",f=r.indexOf(o),c=r.lastIndexOf(a);if(f>=0&&c>=0){let h=r.slice(r.indexOf(">",f)+1,c);document.documentElement.innerHTML=h}}}function G(t){try{let e=new XMLHttpRequest;e.open("GET",g.build(window.location.href,t),!0),e.setRequestHeader("TurboReflex-Token",i.metaElementToken),e.addEventListener("abort",V),e.addEventListener("error",y),e.addEventListener("load",_),e.send()}catch(e){let r=`Unexpected error sending HTTP request! ${e.message}`;y(e,{detail:{message:r}})}}var S={invokeReflex:G};var p={form:T,frame:L,window:S};var m="unknown",F={debug:Object.values(n.events),info:Object.values(n.events),warn:[n.events.abort,n.events.clientError,n.events.missingFrame,n.events.missingFrameSrc,n.events.serverError],error:[n.events.clientError,n.events.missingFrame,n.events.missingFrameSrc,n.events.serverError],unknown:[]};Object.values(n.events).forEach(t=>{addEventListener(t,e=>{F[m].includes(e.type)&&console[m==="debug"?"log":m](e.type,e.detail)})});var I={get level(){return m},set level(t){return Object.keys(F).includes(t)||(t="unknown"),m=t}};function N(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}var O={v4:N};function z(t){let e;try{if(e=i.findClosestReflex(t.target),!e||!l.isRegistered(t.type,e.tagName))return;let r={id:`reflex-${O.v4()}`,name:e.dataset.turboReflex,driver:null,frameId:null,elementId:e.id.length>0?e.id:null,elementAttributes:i.buildAttributePayload(e)};v.add(r),n.dispatch(n.events.beforeStart,e,r);let s=i.findFrameId(e);r.frameId=s;let o;if(s&&(o=i.findFrame(s,e,r),!o))return;let a="window";o&&(a="frame"),e.tagName.toLowerCase()==="form"&&(a="form"),r.driver=a,r.startedAt=new Date().getTime(),n.dispatch(n.events.start,e,r),a!=="form"&&t.preventDefault(),a==="frame"&&p.frame.invokeReflex(o,r),a==="window"&&p.window.invokeReflex(r),a==="form"&&p.form.invokeReflex(e,r)}catch(r){n.dispatch(n.events.clientError,e,{error:r,...payload})}}l.handler=z;l.register("change",["input","select","textarea"]);l.register("submit",["form"]);l.register("click",["*"]);var Ie={logger:I,registerEventDelegate:l.register,get eventDelegates(){return{...l.events}},get lifecycleEvents(){return[...Object.values(n.events)]}};export{Ie as default};
//# sourceMappingURL=turbo_reflex.js.map
