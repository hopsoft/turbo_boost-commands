var T=class{get element(){return document.querySelector('meta[name="turbo-reflex"]')}get token(){return this.element.getAttribute("content")}get busy(){return this.element.dataset.busy==="true"}set busy(e){return this.element.dataset.busy=!!e}},i=new T;var c={start:"turbo-reflex:start",success:"turbo-reflex:success",finish:"turbo-reflex:finish",abort:"turbo-reflex:abort",clientError:"turbo-reflex:client-error",serverError:"turbo-reflex:server-error"},x={stateChange:"turbo-reflex:state:change"},f={...c,...x};function s(t,e=document,r={},o=!1){try{e=e||document;let n=new CustomEvent(t,{detail:r,cancelable:!1,bubbles:!0});e.dispatchEvent(n)}catch(n){if(o)throw n;s(c.clientError,e,{error:n,...r},!0)}}var k;function g(t){let e=k[t];return Array.isArray(e)?[...e]:typeof e=="object"?{...e}:e}function C(t,e={}){return s(x.stateChange,document,{[t]:e}),!0}function D(t,e){if(!t)return t;let r=new Proxy(t,{deleteProperty(o,n){let u=g(e||n);delete o[n];let S=g(e||n);return this.changed=!0,C(e||n,{from:u,to:S})},set(o,n,u,S){(Array.isArray(u)||typeof u=="object")&&(u=D(u,e||n));let J=g(e||n);o[n]=u;let M=g(e||n);return this.changed=!0,C(e||n,{from:J,to:M})}});return k=k||r,r}var $=D;var p={events:x,get base64(){return i.element.dataset.state},get base64Chunks(){return this.base64.match(/.{1,2000}/g)},get data(){let t=atob(this.base64);return $(JSON.parse(t))}};function U(t){let e="<html",r="</html",o=t.indexOf(e),n=t.lastIndexOf(r);if(o>=0&&n>=0){let u=t.slice(t.indexOf(">",o)+1,n);document.documentElement.innerHTML=u}}function V(t){document.body.insertAdjacentHTML("beforeend",t)}var m={append:V,replaceDocument:U};var E={};function B(t){E[t.id]=t}function G(t){delete E[t]}var R={add:B,remove:G,get reflexes(){return[...Object.values(E)]},get length(){return Object.keys(E).length}};function j(t){t.detail.endedAt=new Date().getTime(),t.detail.milliseconds=t.detail.endedAt-t.detail.startedAt,setTimeout(()=>s(c.finish,t.target,t.detail),20)}addEventListener(c.serverError,j);addEventListener(c.success,j);addEventListener(c.finish,t=>R.remove(t.detail.id),!0);var l={events:c};var w={};addEventListener("turbo:before-fetch-request",t=>{let e=t.target.closest("turbo-frame"),{fetchOptions:r}=t.detail;if(i.busy){let o=["text/vnd.turbo-reflex.html",r.headers.Accept];o=o.filter(n=>n&&n.trim().length>0).join(", "),r.headers.Accept=o}r.headers["TurboReflex-Token"]=i.token,p.base64Chunks.forEach((o,n)=>r.headers[`TurboReflex-State-${n.toString().padStart(4,"0")}`]=o)});addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame"),{fetchResponse:r}=t.detail;if(e&&(w[e.id]=e.src),r.header("TurboReflex")){if(r.statusCode<200||r.statusCode>399){let o=`Server returned a ${r.statusCode} status code! TurboReflex requires 2XX-3XX status codes.`;s(l.events.clientError,document,{...t.detail,error:o},!0)}r.header("TurboReflex")==="Append"&&(t.preventDefault(),r.responseText.then(o=>m.append(o)))}});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.turboReflexSrc=w[e.id]||e.src||e.dataset.turboReflexSrc,delete w[e.id]});var z={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",reflexAttribute:"data-turbo-reflex"},a={...z};var A={},q;function Q(t,e){A[t]=e,document.addEventListener(t,q,!0)}function W(t){return Object.keys(A).find(e=>!!A[e].find(r=>Array.from(document.querySelectorAll(r)).find(o=>o===t)))}function Y(t,e){return t===W(e)}var d={events:A,register:Q,isRegisteredForElement:Y,set handler(t){q=t}};function Z(t){return t.closest(`[${a.reflexAttribute}]`)}function K(t){return t.closest("turbo-frame")}function ee(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value||null;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,o)=>(o.selected&&r.push(o.value),r),[])}function te(t){let e=Array.from(t.attributes).reduce((r,o)=>{let n=o.value;return r[o.name]=n,r},{});return e.tag=t.tagName,e.checked=!!t.checked,e.disabled=!!t.disabled,ee(t,e),delete e.class,delete e.action,delete e.href,delete e[a.reflexAttribute],delete e[a.frameAttribute],e}var h={buildAttributePayload:te,findClosestReflex:Z,findClosestFrame:K};function re(t,e={}){e.token=i.token;let r=document.createElement("input");r.type="hidden",r.name="turbo_reflex",r.value=JSON.stringify(e),t.appendChild(r)}var H={invokeReflex:re};function oe(t,e={}){let r=document.createElement("a");r.href=t;let o=new URL(r);return o.searchParams.set("turbo_reflex",JSON.stringify(e)),o}var b={build:oe};function ne(t,e){let r=e.src;e={...e},delete e.src,t.src=b.build(r,e)}var y={invokeReflex:ne};function se(t,e={}){let r=e.src;e={...e},delete e.src,delete e.href,t.setAttribute("href",b.build(r,e))}var N={invokeReflex:se};function ie(t){let e=t.target;s(l.events.abort,document,{xhr:e,...t.detail})}function L(t){let e=t.target;e.getResponseHeader("TurboReflex")==="Append"?m.append(e.responseText):m.replaceDocument(e.responseText);let r=`Server returned a ${e.status} status code! TurboReflex requires 2XX-3XX status codes.`;s(l.events.clientError,document,{xhr:e,...t.detail,error:r},!0)}function ae(t){let e=t.target;if(e.status<200||e.status>399)return L(t);let r=e.responseText;e.getResponseHeader("TurboReflex")==="Append"?m.append(e.responseText):m.replaceDocument(e.responseText)}function ue(t){let e=t.src;t={...t},delete t.src;try{let r=new XMLHttpRequest;r.open("GET",b.build(e,t),!0),r.setRequestHeader("Accept","text/vnd.turbo-reflex.html, text/html, application/xhtml+xml"),r.setRequestHeader("TurboReflex-Token",i.token),p.base64Chunks.forEach((o,n)=>r.setRequestHeader(`TurboReflex-State-${n.toString().padStart(4,"0")}`,o)),r.addEventListener("abort",ie),r.addEventListener("error",L),r.addEventListener("load",ae),r.send()}catch(r){let o=`Unexpected error sending HTTP request! ${r.message}`;L(r,{detail:{message:o}})}}var X={invokeReflex:ue};function O(t,e){return e=e||{dataset:{}},t.href||e.src||e.dataset.turboReflexSrc||location.href}function fe(t){let e=h.findClosestFrame(t),{turboFrame:r,turboMethod:o}=t.dataset;return t.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:e,src:t.action,invokeReflex:H.invokeReflex}:o&&o.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:e,src:t.href,invokeReflex:N.invokeReflex}:r&&r!=="_self"?(e=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:e,src:O(t,e),invokeReflex:y.invokeReflex}):(!r||r==="_self")&&e?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:e,src:O(t,e),invokeReflex:y.invokeReflex}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:O(t),invokeReflex:X.invokeReflex}}var I={find:fe};var v="unknown",P={debug:Object.values(f),info:Object.values(f),warn:[f.abort,f.clientError,f.serverError],error:[f.clientError,f.serverError],unknown:[]};Object.values(f).forEach(t=>{addEventListener(t,e=>{P[v].includes(e.type)&&console[v==="debug"?"log":v](e.type,e.detail)})});var _={get level(){return v},set level(t){return Object.keys(P).includes(t)||(t="unknown"),v=t}};function le(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}var F={v4:le};function ce(t){let e,r={};try{if(e=h.findClosestReflex(t.target),!e||!d.isRegisteredForElement(t.type,e))return;let o=I.find(e);switch(r={id:`reflex-${F.v4()}`,name:e.dataset.turboReflex,driver:o.name,src:o.src,frameId:o.frame?o.frame.id:null,elementId:e.id.length>0?e.id:null,elementAttributes:h.buildAttributePayload(e),startedAt:new Date().getTime()},R.add(r),s(l.events.start,e,r),["frame","window"].includes(o.name)&&t.preventDefault(),i.busy=!0,setTimeout(()=>i.busy=!1,10),o.name){case"method":return o.invokeReflex(e,r);case"form":return o.invokeReflex(e,r);case"frame":return o.invokeReflex(o.frame,r);case"window":return o.invokeReflex(r)}}catch(o){s(l.events.clientError,e,{error:o,...r})}}d.handler=ce;d.register("change",[`input[${a.reflexAttribute}]`,`select[${a.reflexAttribute}]`,`textarea[${a.reflexAttribute}]`]);d.register("submit",[`form[${a.reflexAttribute}]`]);d.register("click",[`[${a.reflexAttribute}]`]);var gt=self.TurboReflex={logger:_,schema:a,registerEventDelegate:d.register,get eventDelegates(){return{...d.events}},get lifecycleEvents(){return[...Object.values(l.events)]},get state(){return p.data}};export{gt as default};
//# sourceMappingURL=turbo_reflex.js.map
