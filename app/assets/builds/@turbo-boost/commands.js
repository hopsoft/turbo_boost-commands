var st=Object.defineProperty,ct=Object.defineProperties;var mt=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var dt=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable;var z=(t,e,r)=>e in t?st(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,s=(t,e)=>{for(var r in e||(e={}))dt.call(e,r)&&z(t,r,e[r]);if(j)for(var r of j(e))ut.call(e,r)&&z(t,r,e[r]);return t},h=(t,e)=>ct(t,mt(e));var lt="TurboBoost-Command",E={boost:"text/vnd.turbo-boost.html",stream:"text/vnd.turbo-stream.html",html:"text/html",xhtml:"application/xhtml+xml",json:"application/json"},ft=(t={})=>{t=s({},t);let e=(t.Accept||"").split(",").map(r=>r.trim()).filter(r=>r.length);return e.unshift(E.boost,E.stream,E.html,E.xhtml),t.Accept=[...new Set(e)].join(", "),t["Content-Type"]=E.json,t["X-Requested-With"]="XMLHttpRequest",t},pt=t=>{if(t){let[e,r,o]=t.split(", ");return{name:e,status:r,strategy:o}}return{}},b={prepare:ft,tokenize:pt,RESPONSE_HEADER:lt};var x={};function bt(t){x[t.id]=t}function ht(t){delete x[t]}var k={add:bt,remove:ht,get commands(){return[...Object.values(x)]},get length(){return Object.keys(x).length}};var i={start:"turbo-boost:command:start",success:"turbo-boost:command:success",finish:"turbo-boost:command:finish",abort:"turbo-boost:command:abort",clientError:"turbo-boost:command:client-error",serverError:"turbo-boost:command:server-error"},l={stateInitialize:"turbo-boost:state:initialize",stateChange:"turbo-boost:state:change"},re=s(s({},i),l);function m(t,e,r={}){return new Promise(o=>{r=r||{},r.detail=r.detail||{},e=e||document;let n=new CustomEvent(t,h(s({},r),{bubbles:!0}));e.dispatchEvent(n),o(n)})}function vt(t){setTimeout(()=>m(i.finish,t.target,{detail:t.detail}))}var gt=[i.abort,i.serverError,i.success];gt.forEach(t=>addEventListener(t,vt));addEventListener(i.finish,t=>k.remove(t.detail.id),!0);var F={events:i};function Et(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16))}var J={v4:Et};var yt=t=>{document.body.insertAdjacentHTML("beforeend",t)},At=t=>{let r=new DOMParser().parseFromString(t,"text/html");TurboBoost.Streams.morph.method(document.documentElement,r.documentElement)},S=(t,e)=>{if(t&&e){if(t.match(/^Append$/i))return yt(e);if(t.match(/^Replace$/i))return At(e)}};var R={};addEventListener("turbo:before-fetch-response",t=>{let e=t.target.closest("turbo-frame");e!=null&&e.id&&(e!=null&&e.src)&&(R[e.id]=e.src);let{fetchResponse:r}=t.detail,o=r.header(b.RESPONSE_HEADER);if(!o)return;t.preventDefault();let{strategy:n}=b.tokenize(o);r.responseHTML.then(c=>S(n,c))});addEventListener("turbo:frame-load",t=>{let e=t.target.closest("turbo-frame");e.dataset.src=R[e.id]||e.src||e.dataset.src,delete R[e.id]});var Ct={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",commandAttribute:"data-turbo-command",confirmAttribute:"data-turbo-confirm",elementCacheAttribute:"data-element-cache"},a=s({},Ct);var M={method:t=>Promise.resolve(confirm(t))},xt=t=>t.detail.driver==="method",kt=t=>{if(t.detail.driver!=="form")return!1;let e=t.target,r=e.closest("turbo-frame"),o=e.closest(`[${a.frameAttribute}]`);return!!(r||o)},St=t=>xt(t)||kt(t);document.addEventListener(i.start,async t=>{let e=t.target.getAttribute(a.confirmAttribute);if(!e||(t.detail.confirmation=!0,St(t)))return;await M.method(e)||t.preventDefault()});var q=M;var f=[],$;function wt(t,e){let r=f.find(o=>o.name===t);return r&&f.splice(f.indexOf(r),1),f=[{name:t,selectors:e},...f],document.removeEventListener(t,$,!0),document.addEventListener(t,$,!0),s({},f.find(o=>o.name===t))}function Ot(t){return f.find(e=>e.selectors.find(r=>Array.from(document.querySelectorAll(r)).find(o=>o===t)))}function Lt(t,e){let r=Ot(e);return r&&r.name===t}var u={register:wt,isRegisteredForElement:Lt,get events(){return[...f]},set handler(t){$=t}};function Tt(t){return t.closest(`[${a.commandAttribute}]`)}function Rt(t){return t.closest("turbo-frame[src]")||t.closest("turbo-frame[data-turbo-frame-src]")||t.closest("turbo-frame")}function $t(t,e={}){if(t.tagName.toLowerCase()!=="select")return e.value=t.value||null;if(!t.multiple)return e.value=t.options[t.selectedIndex].value;e.values=Array.from(t.options).reduce((r,o)=>(o.selected&&r.push(o.value),r),[])}function Nt(t){let e=Array.from(t.attributes).reduce((r,o)=>{let n=o.value;return r[o.name]=n,r},{});return e.tag=t.tagName,e.checked=!!t.checked,e.disabled=!!t.disabled,$t(t,e),delete e.class,delete e.action,delete e.href,delete e[a.commandAttribute],delete e[a.frameAttribute],e}var y={buildAttributePayload:Nt,findClosestCommand:Tt,findClosestFrameWithSource:Rt};var Pt=(t,e={})=>{let r=t.querySelector('input[name="turbo_boost_command"]')||document.createElement("input");r.type="hidden",r.name="turbo_boost_command",r.value=JSON.stringify(e),t.contains(r)||t.appendChild(r)},H={invokeCommand:Pt};var _t=t=>{let e=document.createElement("a");return e.href=t,new URL(e)},U={get commandInvocationURL(){return _t("/turbo-boost-command-invocation")}};var V=t=>{let e=`Unexpected error performing a TurboBoost Command! ${t.message}`;m(F.events.clientError,document,{detail:{message:e,error:t}},!0)},Dt=t=>{let{strategy:e}=b.tokenize(t.headers.get(b.RESPONSE_HEADER));t.text().then(r=>S(e,r))},w=(t={})=>{try{fetch(U.commandInvocationURL.href,{method:"POST",headers:b.prepare({}),body:JSON.stringify(t)}).then(Dt).catch(V)}catch(e){V(e)}};var Bt=(t,e)=>w(e),N={invokeCommand:Bt};var A,P,It=()=>{A=null,P=null},jt=(t,e={})=>{A=t,P=e},zt=t=>{try{if(!A||t.getAttribute("method")!==A.dataset.turboMethod||t.getAttribute("action")!==A.href)return;let e=t.querySelector('input[name="turbo_boost_command"]')||document.createElement("input");e.type="hidden",e.name="turbo_boost_command",e.value=JSON.stringify(P),t.contains(e)||t.appendChild(e)}finally{It()}};document.addEventListener("submit",t=>zt(t.target),!0);var W={invokeCommand:jt};var Ft=(t,e={})=>w(e),X={invokeCommand:Ft};function _(t,e){return e=e||{dataset:{}},t.href||e.src||e.dataset.src||location.href}function Jt(t){let e=y.findClosestFrameWithSource(t),{turboFrame:r,turboMethod:o}=t.dataset;return t.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:e,src:t.action,invokeCommand:H.invokeCommand}:o&&o.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:e,src:t.href,invokeCommand:W.invokeCommand}:r&&r!=="_self"?(e=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:e,src:_(t,e),invokeCommand:N.invokeCommand}):(!r||r==="_self")&&e?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:e,src:_(t,e),invokeCommand:N.invokeCommand}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:_(t),invokeCommand:X.invokeCommand}}var D={find:Jt};var L="unknown",K=!1,O=[],v={debug:Object.values(i),info:Object.values(i),warn:[i.abort,i.clientError,i.serverError],error:[i.clientError,i.serverError],unknown:[]},Mt=t=>{if(!v[L].includes(t.type)||typeof console[L]!="function")return!1;let{detail:e}=t;if(!e.id)return!0;let r=`${t.type}-${e.id}`;return O.includes(r)?!1:(O.length>16&&O.shift(),O.push(r),!0)},qt=t=>v.error.includes(t.type)?"error":v.warn.includes(t.type)?"warn":v.info.includes(t.type)?"info":v.debug.includes(t.type)?"debug":"log",Ht=t=>{if(Mt(t)){let{target:e,type:r,detail:o}=t,n=o.id||"",c=o.name||"",d="";o.startedAt&&(d=`${Date.now()-o.startedAt}ms `);let p=r.split(":"),it=p.pop(),I=`%c${p.join(":")}:%c${it}`,at=[`%c${c}`,`%c${d}`,I];console[qt(t)](at.join(" ").replace(/\s{2,}/g," "),"color:deepskyblue","color:lime","color:darkgray",I.match(/abort|error/i)?"color:red":"color:deepskyblue",{id:n,detail:o,target:e})}};K||(K=!0,Object.values(i).forEach(t=>addEventListener(t,e=>Ht(e))));var G={get level(){return L},set level(t){return Object.keys(v).includes(t)||(t="unknown"),L=t}};var B;function T(t,e=null){if(!t||typeof t!="object")return t;let r=new Proxy(t,{deleteProperty(o,n){return delete o[n],m(l.stateChange,document,{detail:{state:B}}),!0},set(o,n,c,d){return o[n]=T(c,this),m(l.stateChange,document,{detail:{state:B}}),!0}});if(Array.isArray(t))t.forEach((o,n)=>t[n]=T(o,r));else if(typeof t=="object")for(let[o,n]of Object.entries(t))t[o]=T(n,r);return e||(B=r),r}var Q=T;function Ut(t,e){return typeof e!="object"&&(e={}),sessionStorage.setItem(String(t),JSON.stringify(e))}function Vt(t){let e=sessionStorage.getItem(String(t));return e?JSON.parse(e):{}}var C={save:Ut,find:Vt};var Z={},Y={};function Wt(t,e){removeEventListener(l.stateChange,Y[t]),Y[t]=addEventListener(l.stateChange,r=>{for(let[o,n]of Object.entries(e.current))e.initial[o]!==n&&(e.optimistic[o]=n);C.save(t,e)})}function tt(t={}){let r=s(s({},{key:null,initial:{},current:{},optimistic:{},signed:null}),t),{key:o}=r;return o&&(r.current=Q(s({},r.initial)),Wt(o,r),Z[o]=r,C.save(o,r)),r}function Xt(t,e,r){let o=tt({key:t,initial:JSON.parse(e),signed:r});return setTimeout(()=>m(l.stateInitialize,document,{detail:o})),o}function et(t){return tt(s({key:t},C.find(t)))}function Kt(){let t="TurboBoost::Commands::ElementCache",e=et(t);return document.querySelectorAll(`[${a.elementCacheAttribute}]`).forEach(r=>{let o=r.getAttribute("id");if(o)try{let c=JSON.parse(r.getAttribute(a.elementCacheAttribute)).reduce((d,p)=>(r.hasAttribute(p)&&(d[p]=r.getAttribute(p)||r[p]),d),{});Object.entries(c).length>0&&(e.current[o]=c)}catch(n){let c=`Elements configured for TurboBoost caching must have a valid JSON string as the value of the ${a.elementCacheAttribute} attribute!`;m(i.clientError,r,{detail:{message:c}})}else m(i.clientError,r,{detail:{message:"Elements configured for TurboBoost caching must have an id attribute!"}})}),C.save(t,e),e}var g={initialize:Xt,buildElementCache:Kt,entries:Z,find:et};var rt="0.2.1";var Gt=self.TurboBoost||{},nt={VERSION:rt,active:!1,confirmation:q,logger:G,schema:a,events:i,registerEventDelegate:u.register,get eventDelegates(){return u.events}};function ot(t,e){let r=e.getAttribute(a.commandAttribute),o=g.find(r),n=g.buildElementCache();return{id:t,name:e.getAttribute(a.commandAttribute),elementId:e.id.length>0?e.id:null,elementAttributes:y.buildAttributePayload(e),startedAt:Date.now(),elementCache:n.optimistic,state:{optimistic:o.optimistic,signed:o.signed}}}async function Qt(t){let e,r={};try{if(e=y.findClosestCommand(t.target),!e||!u.isRegisteredForElement(t.type,e))return;let o=J.v4(),n=D.find(e),c=h(s({},ot(o,e)),{driver:n.name,frameId:n.frame?n.frame.id:null,src:n.src}),d=await m(i.start,e,{cancelable:!0,detail:c});if(d.defaultPrevented||d.detail.confirmation&&t.defaultPrevented)return m(i.abort,e,{detail:{message:`An event handler for '${i.start}' prevented default behavior and blocked command invocation!`,source:d}});switch(n=D.find(e),c=h(s({},ot(o,e)),{driver:n.name,frameId:n.frame?n.frame.id:null,src:n.src}),k.add(c),["frame","window"].includes(n.name)&&t.preventDefault(),n.name){case"method":return n.invokeCommand(e,c);case"form":return n.invokeCommand(e,c,t);case"frame":return n.invokeCommand(n.frame,c);case"window":return n.invokeCommand(self,c)}}catch(o){m(i.clientError,e,{detail:h(s({},r),{error:o})})}}self.TurboBoost=s({},Gt);self.TurboBoost.Commands||(u.handler=Qt,u.register("click",[`[${a.commandAttribute}]`]),u.register("submit",[`form[${a.commandAttribute}]`]),u.register("toggle",[`details[${a.commandAttribute}]`]),u.register("change",[`input[${a.commandAttribute}]`,`select[${a.commandAttribute}]`,`textarea[${a.commandAttribute}]`]),self.TurboBoost.Commands=nt,self.TurboBoost.State={entries:g.entries,find:g.find,initialize:g.initialize});var yr=nt;export{yr as default};
//# sourceMappingURL=commands.js.map
