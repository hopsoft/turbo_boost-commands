var ne=Object.defineProperty,ae=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var ie=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var M=(e,t,r)=>t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,a=(e,t)=>{for(var r in t||(t={}))ie.call(t,r)&&M(e,r,t[r]);if(I)for(var r of I(t))me.call(t,r)&&M(e,r,t[r]);return e},u=(e,t)=>ae(e,se(t));var de="TurboBoost-Command",h={boost:"text/vnd.turbo-boost.html",stream:"text/vnd.turbo-stream.html",html:"text/html",xhtml:"application/xhtml+xml",json:"application/json"},ce=(e={})=>{e=a({},e);let t=(e.Accept||"").split(",").map(r=>r.trim()).filter(r=>r.length);return t.unshift(h.boost,h.stream,h.html,h.xhtml),e.Accept=[...new Set(t)].join(", "),e["Content-Type"]=h.json,e["X-Requested-With"]="XMLHttpRequest",e},ue=e=>{if(e){let[t,r,o]=e.split(", ");return{name:t,status:r,strategy:o}}return{}},b={prepare:ce,tokenize:ue,RESPONSE_HEADER:de};var A={};function le(e){A[e.id]=e}function fe(e){delete A[e]}var x={add:le,remove:fe,get commands(){return[...Object.values(A)]},get length(){return Object.keys(A).length}};var s={start:"turbo-boost:command:start",success:"turbo-boost:command:success",finish:"turbo-boost:command:finish",abort:"turbo-boost:command:abort",clientError:"turbo-boost:command:client-error",serverError:"turbo-boost:command:server-error"},l={stateLoad:"turbo-boost:state:load",stateChange:"turbo-boost:state:change"},c=a(a({},s),l);function m(e,t,r={}){return new Promise(o=>{r=r||{},r.detail=r.detail||{},t=t||document;let n=new CustomEvent(e,u(a({},r),{bubbles:!0}));t.dispatchEvent(n),o(n)})}function j(e){e.detail.endedAt=Date.now(),e.detail.ms=e.detail.endedAt-e.detail.startedAt,setTimeout(()=>m(s.finish,e.target,{detail:e.detail}),25)}addEventListener(s.serverError,j);addEventListener(s.success,j);addEventListener(s.finish,e=>x.remove(e.detail.id),!0);var H={events:s};function pe(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}var U={v4:pe};var be=e=>{document.body.insertAdjacentHTML("beforeend",e)},he=e=>{let r=new DOMParser().parseFromString(e,"text/html");TurboBoost.Streams.morph.method(document.documentElement,r.documentElement)},k=(e,t)=>{if(!e)return console.warn("TurboBoost::Commands unable to render! (strategy not defined)");if(!t)return console.warn("TurboBoost::Commands unable to render! (content not defined)");if(e.match(/^Append$/i))return be(t);if(e.match(/^Replace$/i))return he(t)};var O={};addEventListener("turbo:before-fetch-response",e=>{let t=e.target.closest("turbo-frame");t!=null&&t.id&&(t!=null&&t.src)&&(O[t.id]=t.src);let{fetchResponse:r}=e.detail,o=r.header(b.RESPONSE_HEADER);if(!o)return;e.preventDefault();let{strategy:n}=b.tokenize(o);r.responseHTML.then(d=>k(n,d))});addEventListener("turbo:frame-load",e=>{let t=e.target.closest("turbo-frame");t.dataset.src=O[t.id]||t.src||t.dataset.src,delete O[t.id]});var ve={frameAttribute:"data-turbo-frame",methodAttribute:"data-turbo-method",commandAttribute:"data-turbo-command",confirmAttribute:"data-turbo-confirm"},i=a({},ve);var q={method:e=>Promise.resolve(confirm(e))},ge=e=>e.detail.driver==="method",Ee=e=>{if(e.detail.driver!=="form")return!1;let t=e.target,r=t.closest("turbo-frame"),o=t.closest(`[${i.frameAttribute}]`);return!!(r||o)},ye=e=>ge(e)||Ee(e);document.addEventListener(s.start,async e=>{let t=e.target.getAttribute(i.confirmAttribute);if(!t||(e.detail.confirmation=!0,ye(e)))return;await q.method(t)||e.preventDefault()});var z=q;var f=[],R;function Ce(e,t){let r=f.find(o=>o.name===e);return r&&f.splice(f.indexOf(r),1),f=[{name:e,selectors:t},...f],document.removeEventListener(e,R,!0),document.addEventListener(e,R,!0),a({},f.find(o=>o.name===e))}function Ae(e){return f.find(t=>t.selectors.find(r=>Array.from(document.querySelectorAll(r)).find(o=>o===e)))}function xe(e,t){let r=Ae(t);return r&&r.name===e}var p={register:Ce,isRegisteredForElement:xe,get events(){return[...f]},set handler(e){R=e}};function ke(e){return e.closest(`[${i.commandAttribute}]`)}function Se(e){return e.closest("turbo-frame[src]")||e.closest("turbo-frame[data-turbo-frame-src]")||e.closest("turbo-frame")}function we(e,t={}){if(e.tagName.toLowerCase()!=="select")return t.value=e.value||null;if(!e.multiple)return t.value=e.options[e.selectedIndex].value;t.values=Array.from(e.options).reduce((r,o)=>(o.selected&&r.push(o.value),r),[])}function Le(e){let t=Array.from(e.attributes).reduce((r,o)=>{let n=o.value;return r[o.name]=n,r},{});return t.tag=e.tagName,t.checked=!!e.checked,t.disabled=!!e.disabled,we(e,t),delete t.class,delete t.action,delete t.href,delete t[i.commandAttribute],delete t[i.frameAttribute],t}var v={buildAttributePayload:Le,findClosestCommand:ke,findClosestFrameWithSource:Se};var Te=(e,t={})=>{let r=e.querySelector('input[name="turbo_boost_command"]')||document.createElement("input");r.type="hidden",r.name="turbo_boost_command",r.value=JSON.stringify(t),e.contains(r)||e.appendChild(r)},J={invokeCommand:Te};var _;function S(e,t=null){if(!e||typeof e!="object")return e;let r=new Proxy(e,{deleteProperty(o,n){return delete o[n],m(l.stateChange,document,{detail:{state:_}}),!0},set(o,n,d,C){return o[n]=S(d,this),m(l.stateChange,document,{detail:{state:_}}),!0}});if(Array.isArray(e))e.forEach((o,n)=>e[n]=S(o,r));else if(typeof e=="object")for(let[o,n]of Object.entries(e))e[o]=S(n,r);return t||(_=r),r}var V=S;var D,w,P,W;function Oe(e,t){let r=JSON.parse(e);D=a({},r),W=t,w=V(r),P={},setTimeout(()=>m(l.stateLoad,document,{detail:{state:w}}))}addEventListener(l.stateChange,e=>{for(let[t,r]of Object.entries(w))D[t]!==r&&(P[t]=r)});var g={initialize:Oe,events:l,get initial(){return D},get current(){return w},get changed(){return P},get signed(){return W}};var Re=e=>{let t=document.createElement("a");return t.href=e,new URL(t)},X={get commandInvocationURL(){return Re("/turbo-boost-command-invocation")}};var G=e=>{let t=`Unexpected error performing a TurboBoost Command! ${e.message}`;m(H.events.clientError,document,{detail:{error:t}},!0)},_e=e=>{let{strategy:t}=b.tokenize(e.headers.get(b.RESPONSE_HEADER));e.text().then(r=>k(t,r))},L=(e={})=>{try{fetch(X.commandInvocationURL.href,{method:"POST",headers:b.prepare({}),body:JSON.stringify(e)}).then(_e).catch(G)}catch(t){G(t)}};var De=(e,t)=>L(t),$={invokeCommand:De};var E,B,Pe=()=>{E=null,B=null},$e=(e,t={})=>{E=e,B=t},Be=e=>{try{if(!E||e.getAttribute("method")!==E.dataset.turboMethod||e.getAttribute("action")!==E.href)return;let t=e.querySelector('input[name="turbo_boost_command"]')||document.createElement("input");t.type="hidden",t.name="turbo_boost_command",t.value=JSON.stringify(B),e.contains(t)||e.appendChild(t)}finally{Pe()}};document.addEventListener("submit",e=>Be(e.target),!0);var K={invokeCommand:$e};var Ne=(e,t={})=>L(t),Q={invokeCommand:Ne};function N(e,t){return t=t||{dataset:{}},e.href||t.src||t.dataset.src||location.href}function Fe(e){let t=v.findClosestFrameWithSource(e),{turboFrame:r,turboMethod:o}=e.dataset;return e.tagName.toLowerCase()==="form"?{name:"form",reason:"Element is a form.",frame:t,src:e.action,invokeCommand:J.invokeCommand}:o&&o.length>0?{name:"method",reason:"Element defines data-turbo-method.",frame:t,src:e.href,invokeCommand:K.invokeCommand}:r&&r!=="_self"?(t=document.getElementById(r),{name:"frame",reason:"element targets a frame that is not _self",frame:t,src:N(e,t),invokeCommand:$.invokeCommand}):(!r||r==="_self")&&t?{name:"frame",reason:"element does NOT target a frame or targets _self and is contained by a frame",frame:t,src:N(e,t),invokeCommand:$.invokeCommand}:{name:"window",reason:"element matches one or more of the following conditions (targets _top, does NOT target a frame, is NOT contained by a frame)",frame:null,src:N(e),invokeCommand:Q.invokeCommand}}var F={find:Fe};var y="unknown",Y=!1,T=[],Z={debug:Object.values(c),info:Object.values(c),warn:[c.abort,c.clientError,c.serverError],error:[c.clientError,c.serverError],unknown:[]},Ie=e=>{if(!Z[y].includes(e.type)||typeof console[y]!="function")return!1;let{detail:t}=e;if(!t.id)return!0;let r=`${e.type}-${t.id}`;return T.includes(r)?!1:(T.length>16&&T.shift(),T.push(r),!0)},Me=e=>{if(Ie(e)){let{target:t,type:r,detail:o}=e,n={};o.id&&(n.id=o.id),o.ms&&(n.ms=o.ms),console[y](r,u(a({},n),{detail:o,target:t}))}};Y||(Y=!0,Object.values(c).forEach(e=>addEventListener(e,t=>Me(t))));var ee={get level(){return y},set level(e){return Object.keys(Z).includes(e)||(e="unknown"),y=e}};var te="0.2.1";var je=self.TurboBoost||{},oe={VERSION:te,active:!1,confirmation:z,logger:ee,schema:i,events:s,registerEventDelegate:p.register,get eventDelegates(){return p.events}};function re(e,t){return{id:e,name:t.getAttribute(i.commandAttribute),elementId:t.id.length>0?t.id:null,elementAttributes:v.buildAttributePayload(t),startedAt:Date.now(),changedState:g.changed,clientState:g.current,signedState:g.signed}}async function He(e){let t,r={};try{if(t=v.findClosestCommand(e.target),!t||!p.isRegisteredForElement(e.type,t))return;let o=`turbo-command-${U.v4()}`,n=F.find(t),d=u(a({},re(o,t)),{driver:n.name,frameId:n.frame?n.frame.id:null,src:n.src}),C=await m(s.start,t,{cancelable:!0,detail:d});if(C.defaultPrevented||C.detail.confirmation&&e.defaultPrevented)return m(s.abort,t,{detail:{message:`An event handler for '${s.start}' prevented default behavior and blocked command invocation!`,source:C}});switch(n=F.find(t),d=u(a({},re(o,t)),{driver:n.name,frameId:n.frame?n.frame.id:null,src:n.src}),x.add(d),["frame","window"].includes(n.name)&&e.preventDefault(),n.name){case"method":return n.invokeCommand(t,d);case"form":return n.invokeCommand(t,d,e);case"frame":return n.invokeCommand(n.frame,d);case"window":return n.invokeCommand(self,d)}}catch(o){m(s.clientError,t,{detail:u(a({},r),{error:o})})}}self.TurboBoost=a({},je);self.TurboBoost.Commands||(p.handler=He,p.register("click",[`[${i.commandAttribute}]`]),p.register("submit",[`form[${i.commandAttribute}]`]),p.register("change",[`input[${i.commandAttribute}]`,`select[${i.commandAttribute}]`,`textarea[${i.commandAttribute}]`]),self.TurboBoost.Commands=oe,self.TurboBoost.State=g);var cr=oe;export{cr as default};
//# sourceMappingURL=commands.js.map
