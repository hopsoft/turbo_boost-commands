---
kind: pipeline
type: docker
name: default

steps:
  - name: restore-cache
    image: meltwater/drone-cache:v1
    settings:
      backend: filesystem
      restore: true
      archive_format: gzip
      filesystem_cache_root: /cache
      mount:
        - /cache/hopsoft-images
    volumes:
      - name: cache
        path: /cache

  - name: build-image
    image: plugins/docker
    settings:
      context: .
      force_tag: true
      insecure: true
      registry: registry:5000
      repo: registry:5000/hopsoft/turbo_boost-commands
      storage_path: /cache/hopsoft-images
      tags: ci-${DRONE_COMMIT_SHA}
      use_cache: true
      volumes:
        - name: cache
          path: /cache

  - name: rebuild-cache
    image: meltwater/drone-cache:v1
    settings:
      backend: filesystem
      rebuild: true
      archive_format: gzip
      filesystem_cache_root: /cache
      mount:
        - /cache/hopsoft-images
    volumes:
      - name: cache
        path: /cache

  - name: peek-cache
    image: alpine
    commands:
      - apk update
      - apk add tree
      - tree /cache/hopsoft-images
    volumes:
      - name: cache
        path: /cache

  - name: check-standardrb
    image: hopsoft/turbo_boost-commands:ci-${DRONE_COMMIT_SHA}
    pull: never
    commands:
      - shopt -s globstar
      - bundle exec standardrb --format progress
    volumes:
      - name: cache
        path: /cache

#---
#kind: pipeline
#type: docker
#name: default

#steps:
#- name: Build
  #image: plugins/docker
  #settings:
    #context: .
    #force_tag: true
    #insecure: true
    #registry: registry:5000
    #repo: registry:5000/hopsoft/turbo_boost-commands
    #storage_path: /cache
    #tags: ci
    #use_cache: true

#- name: Network Test
  #image: alpine
  #commands:
  #- ping -c 4 registry

#- name: StandardRB
  #image: registry:5000/hopsoft/turbo_boost-commands:ci
  #commands:
  #- ping -c 4 registry
  #- shopt -s globstar
  #- bundle exec standardrb --format progress
